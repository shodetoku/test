name: Discord GitHub Notifications

on:
  push:
    branches: ["**"]
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        if: always() # Ensures notification sends on failure too!
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          # Mapping data to Envs to avoid shell escaping issues
          MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          URL: ${{ github.event.head_commit.url || github.event.pull_request.html_url }}
          STATUS: ${{ job.status }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          AUTHOR: ${{ github.actor }}
        run: |
          # Set UI details based on status
          if [ "$STATUS" = "success" ]; then
            COLOR=3066993
            EMOJI="✅"
          else
            COLOR=15158332
            EMOJI="❌"
          fi

          # Construct the JSON using a Heredoc for better readability
          curl -H "Content-Type: application/json" \
               -X POST \
               -d @- <<EOF
          {
            "username": "GitHub",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [{
              "title": "$EMOJI Workflow $STATUS",
              "url": "$URL",
              "color": $COLOR,
              "author": {
                "name": "$AUTHOR",
                "icon_url": "https://github.com/$AUTHOR.png"
              },
              "fields": [
                { "name": "Repository", "value": "[$REPO](https://github.com/$REPO)", "inline": true },
                { "name": "Branch", "value": "\`$BRANCH\`", "inline": true },
                { "name": "Event", "value": "${{ github.event_name }}", "inline": true },
                { "name": "Message", "value": "$MESSAGE", "inline": false }
              ],
              "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
              "footer": { "text": "GitHub Actions" }
            }]
          }
          EOF
